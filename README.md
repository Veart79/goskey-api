# README.md

# Node Goskey-api Service

Этот проект представляет собой REST сервис, реализованный на Node.js с использованием Express. Сервис предоставляет методы для авторизации и отправки документов на подпись в Госключе.
А также может использоваться для подписи документов алгоритмами ГОСТ.



## Установка

1. Клонируйте репозиторий:
   ```
   git clone https://gitlab.kmiac.ru/node/goskey-api.git
   ```
2. Перейдите в директорию проекта:
   ```
   cd goskey-api
   ```
3. Установите зависимости:
   ```
   npm install
   ```
4. Настройте .env, Скопируйте сертификаты, Пропишите токены для клиентов  (см. ниже)




## Запуск

Для запуска сервиса используйте команду:
```
npm start
```

Сервис будет доступен по адресу `http://localhost:3000`.

## Настройка

### Настройка .env
Настройки в файле .env
```
# Url API ЕСИА для получения токена доступа к API
ESIA_API_URL=https://esia-portal1.test.gosuslugi.ru/esia-rs/api/public/v1/orgs/ext-app
# Url API ЕПГУ для работы с Госключом
EPGU_API_URL=https://svcdev-beta.test.gosuslugi.ru/api
# APIKey (UUID сотрудника в ЕСИА)
ESIA_API_KEY=12345678-aaaa-bbbb-cccc-123456789012
# Папка сертификатов. Если пусто, то используется папка src/data в корне проекта
ESIA_CERT_DIR=
# Имя сертификата без расширения (в коде для сертификата добавляется .crt для ключа .key)
ESIA_CERTNAME_DEF=final
# Уровень логирования
LOG_LEVEL=info
# Порт сервиса
PORT=3000
```

### Установка сертификатов
В папку сертификатом (ESIA_CERT_DIR в настройках или src/data по умолчанию) копируются сертификаты в формате PEM (текстовый base64). Имя ключа и сертификата должны быть одинаковыми. Расширение для сертификата .crt для ключа .key  Переименуйте если названия не соответствуют.
Поддерживаются сертификаты ГОСТ 2012.

### Шаблон запроса-заявления на подпись в Госключе
Шаблон находится в файле `src/data/req.xml.tpl`
Задайте атрибуты для вашей ИС, подключенной к Госключу:
`mnemonics` - Мнемоника ИС, которая отправляет документ на подпись
`orgName` - Название организации или ИС, которая отправляет документ на подпись

## API

### Авторизация

Реализована упрощенная авторизация по постоянному токену (не JWT). Токен передается в заголовке запроса (Authorization: token1). Список допустимых токенов хранится в файле `src/data/tokens.json`.
Токен выдается системе-клиенту персонально, вручную добавляется в tokens.json.


### Методы

1. **push** (POST) Отправка файла на подпись в Госключ пользователю с указанным СНИЛС.
   При этом происходит автоматическое создание заявления на подпись документа (req.xml), которое подписывается ключом и сертификатом Организации-вендора из настроек, также подписывается сам файл и формируется архив (4 файла) для отправки в сервис ЕПГУ.
   Предварительно происходит авторизация в АПИ ЕСИА, где для получения токена также используется подпись сертификатом из настроек.
   Подробнее в спецификации Госключа:
   https://gu-st.ru/content/partners/api_for_gu/Specifikaciya_API_EPGU_Otpravka_dokumentov_na_podpis_v_Gosklyuch_v1.8.docx
   https://svcdev-partners.test.gosuslugi.ru/catalog/goskey

   - Параметры (json):
     - `file` - base64 кодированное содержимое файла
     - `snils` - СНИЛС подписанта
     - `format` - (необязательно) По умолчанию base64

   - Возвращает:
     - `order` - номер заказа

   - Пример:
   ```
   {
      "snils":"062-461-474 49",
      "file": "Тектовые данные",
      "format": "utf-8"
   }
   ```

2. **status** (GET)
   Проверка статуса подписания документа в Госключе.
   - Параметры:
     - `order` - номер заказа
   - Возвращает статус заказа.

   - Пример:
   `10.80.0.95:3000/status?orderId=4650451905`

3. **pull** (GET)
   Получение подписи в Госключе по номеру заказа.
   - Параметры:
     - `order` - номер заказа
     - `mimeType` (необязательный) Можно указать для "application/xml" для получения исходного документа вместо подписи
   - Возвращает подпись в формате base64.

   - Пример:
   `10.80.0.95:3000/pull?orderId=4650452302`

4. **sign** (POST)
   Подписывает документ указанной подписью. Метод не используется напрямую для работы с Госключом. Может использоваться для подписания документов алгоритмами ГОСТ для сторонних задач. Подписывает только текстовые данные (даже в base64 при раскодировке должен быть utf-8).
   - Параметры (json):
     - `data` - данные для подписи (в base64 либо см. `format`)
     - `certname` - (необязательный) имя сертификата (без расширения) из списка установленных в сервисе. По умолчанию используется подпись из настроек в .env
     - `format` - (необязательный, по умолчанию base64) Формат входных данных (в параметре `data`) utf-8 | base64
     - `outformat` - (необязательный, по умолчанию base64) Формат выходных данных (подписи)  utf-8 | base64 | base64url
     - `signedAttr` - (необязательный) Подписываемые параметры true | false | объект с атрибутами. Если true, до добавляет атрибуты contentType и signingTime в подпись

   - Возвращает подпись в формате `outformat` (по умолчанию base64).

   - Пример:
   ```
   {
      "data": "Тектовые данные",
      "format": "utf-8"
   }
   ```
